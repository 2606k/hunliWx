<!--pages/story/story.wxml-->
<view class="container">
  <!-- èƒŒæ™¯éŸ³ä¹ç»„ä»¶ -->
  <bgm></bgm>
  <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
  <home-btn></home-btn>
  <!-- é¡µé¢æ ‡é¢˜ -->
  <!-- <view class="page-header">
    <view class="title"></view>
    <view class="subtitle"></view>
  </view> -->

  <!-- æ–°å¢æ•…äº‹æŒ‰é’®ï¼ˆå·²éšè—ï¼‰ -->
  <view class="add-btn" bindtap="showAddStoryModal" v-if="openid != 'oIFv26_VRFlCl0mJ7Iy8HnWFo-xk'">
    <text class="add-icon">+</text>
    <text class="add-text">æ–°å¢æ•…äº‹</text>
  </view>

  <!-- æ—¶é—´è½´ -->
  <view class="timeline">
    <view class="timeline-item" wx:for="{{stories}}" wx:key="id">
      <!-- æ—¶é—´è½´å·¦ä¾§ -->
      <view class="timeline-left">
        <view class="timeline-date" style="background-image: url('http://124.222.172.221:9000/marry/storydate.png');width: 120px;">
          <view class="date-time">{{item.eventTimeStr}}</view>
        </view>
      </view>

      <!-- æ—¶é—´è½´å³ä¾§å†…å®¹ -->
      <view class="timeline-content">
        <view class="story-card" bindlongpress="showDeleteConfirm" data-id="{{item.id}}" data-title="{{item.title}}">
          <view class="story-title">
            {{item.title}}
            <view class="delete-btn" catchtap="showDeleteConfirm" data-id="{{item.id}}" data-title="{{item.title}}">
              <text class="delete-icon">Ã—</text>
            </view>
          </view>
          <view class="story-content-wrapper">
            <!-- å›¾æ–‡æ··æ’å†…å®¹ -->
            <rich-text nodes="{{item.parsedContent}}" class="story-content"></rich-text>
            <image wx:if="{{item.gender == 1}}" class="gender-icon" src="http://124.222.172.221:9000/marry/1.svg" mode="aspectFit"></image>
            <image wx:if="{{item.gender == 0}}" class="gender-icon" src="http://124.222.172.221:9000/marry/0.svg" mode="aspectFit"></image>
          </view>
          
          <!-- æ•…äº‹é…å›¾ -->
          <view class="story-images" wx:if="{{item.photos && item.photos.length > 0}}">
            <image 
              wx:for="{{item.photos}}" 
              wx:for-item="photo" 
              wx:key="id"
              src="{{photo.url}}" 
              mode="aspectFill" 
              class="story-image"
              bindtap="previewImage"
              data-urls="{{item.photos}}"
              data-current="{{photo.url}}"
            ></image>
          </view>
          
          <!-- ç§»é™¤æ•…äº‹æ—¶é—´æ˜¾ç¤ºï¼Œå·²ç»æ˜¾ç¤ºåœ¨å·¦ä¾§å›¾ç‰‡ä¸Š -->
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore}}">
    <button class="btn-secondary" bindtap="loadMore" loading="{{loading}}">
      åŠ è½½æ›´å¤šæ•…äº‹
    </button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{stories.length === 0 && !loading}}">
    <view class="empty-text">è¿˜æ²¡æœ‰æ•…äº‹ï¼Œæ•¬è¯·æœŸå¾…...</view>
  </view>

  <!-- æ–°å¢æ•…äº‹å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="hideAddStoryModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">æ–°å¢æ•…äº‹</text>
        <text class="modal-close" bindtap="hideAddStoryModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">æ•…äº‹æ ‡é¢˜</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥æ•…äº‹æ ‡é¢˜" value="{{formData.title}}" bindinput="onTitleInput" />
        </view>
        
        <view class="form-group">
          <text class="form-label">æ•…äº‹å†…å®¹</text>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥æ•…äº‹å†…å®¹" value="{{formData.content}}" bindinput="onContentInput" maxlength="2000"></textarea>
          
          <!-- å›¾æ–‡æ··æ’å·¥å…·æ  -->
          <view class="rich-editor-toolbar">
            <view class="toolbar-btn" bindtap="insertImage">
              <text class="toolbar-icon">ğŸ–¼ï¸</text>
              <text class="toolbar-text">æ’å…¥å›¾ç‰‡</text>
            </view>
          </view>
          
          <!-- å›¾æ–‡æ··æ’é¢„è§ˆ -->
          <!-- <view class="rich-content-preview" wx:if="{{richContentPreview.length > 0}}">
            <view class="preview-title">å†…å®¹é¢„è§ˆï¼š</view>
            <view class="preview-blocks">
              <block wx:for="{{richContentPreview}}" wx:key="index">
                <text wx:if="{{item.type === 'text'}}" class="preview-text">{{item.content}}</text>
                <block wx:if="{{item.type === 'image'}}">
                  <view class="image-container">
                    <image src="{{item.content}}" mode="widthFix" class="preview-rich-image" binderror="onImageError" data-index="{{index}}" bindload="onImageLoad" data-index="{{index}}"></image>
                    <view class="image-debug-info">
                      <view class="image-url-debug">æ˜¾ç¤ºURL: {{item.content}}</view>
                      <view class="image-url-debug" wx:if="{{item.originalUrl !== item.content}}">åŸå§‹URL: {{item.originalUrl}}</view>
                      <view class="image-load-status" wx:if="{{item.loadStatus}}">çŠ¶æ€: {{item.loadStatus}}</view>
                    </view>
                  </view>
                </block>
              </block>
            </view>
          </view> -->
        </view>
        
        <view class="form-group">
          <text class="form-label">æ€§åˆ«</text>
          <radio-group class="gender-radio-group" bindchange="onGenderChange">
            <label class="radio-label">
              <radio value="1" checked="{{formData.gender == 1}}" />ç”·ä¸»
            </label>
            <label class="radio-label">
              <radio value="0" checked="{{formData.gender == 0}}" />å¥³ä¸»
            </label>
          </radio-group>
        </view>
        
        <view class="form-group">
          <text class="form-label">æ•…äº‹æ—¶é—´</text>
          <picker mode="date" value="{{formData.eventTime}}" bindchange="onDateChange">
            <view class="form-picker">
              <text>{{formData.eventTime || 'è¯·é€‰æ‹©æ•…äº‹æ—¶é—´'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-secondary" bindtap="hideAddStoryModal">å–æ¶ˆ</button>
        <button class="btn-primary" bindtap="addStory" loading="{{submitting}}">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view> 